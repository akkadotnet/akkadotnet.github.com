<!DOCTYPE html>
<!--[if IE 8]>			<html class="ie ie8"> <![endif]-->
<!--[if IE 9]>			<html class="ie ie9"> <![endif]-->
<!--[if gt IE 9]><!-->	<html> <!--<![endif]-->
	<head>
		

<meta charset="utf-8" />
<title>Akka.Cluster.Sharding module | Akka.NET</title>

<meta name="keywords" content="Actor,Finite state machine, concurrency" />
<meta name="description" content="" />
<meta name="Author" content="Dorin Grigoras [www.stepofweb.com]" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />

<!-- mobile settings -->
<meta name="viewport" contenht="width=device-width, maximum-scale=1, initial-scale=1, user-scalable=0" />

<!-- Favicon -->
<link rel="shortcut icon" href="/theme_assets/images/demo/favicon.ico" />

<!-- WEB FONTS -->
<link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,700,800&amp;subset=latin,latin-ext" rel="stylesheet" type="text/css" />

<!-- CORE CSS -->
<link href="/theme_assets/plugins/bootstrap/css/bootstrap.min.css" rel="stylesheet" type="text/css" />
<link href="/theme_assets/css/font-awesome.css" rel="stylesheet" type="text/css" />
<link href="/theme_assets/css/sky-forms.css" rel="stylesheet" type="text/css" />
<link href="/theme_assets/css/weather-icons.min.css" rel="stylesheet" type="text/css" />
<link href="/theme_assets/css/line-icons.css" rel="stylesheet" type="text/css" />
<link href="/theme_assets/plugins/owl-carousel/owl.pack.css" rel="stylesheet" type="text/css" />
<link href="/theme_assets/plugins/magnific-popup/magnific-popup.css" rel="stylesheet" type="text/css" />
<link href="/theme_assets/css/animate.css" rel="stylesheet" type="text/css" />
<link href="/theme_assets/css/flexslider.css" rel="stylesheet" type="text/css" />

<!-- FAV ICON -->
<link rel="shortcut icon" href="http://akkadotnet.github.io/favicon.ico?v=2" />

<!-- REVOLUTION SLIDER -->
<link href="/theme_assets/css/revolution-slider.css" rel="stylesheet" type="text/css" />
<link href="/theme_assets/css/layerslider.css" rel="stylesheet" type="text/css" />

<!-- BLOG -->
<link href="/theme_assets/css/layout-blog.css" rel="stylesheet" type="text/css" />

<!-- THEME CSS -->
<link href="/theme_assets/css/essentials.css" rel="stylesheet" type="text/css" />
<link href="/theme_assets/css/layout.css" rel="stylesheet" type="text/css" />
<link href="/theme_assets/css/header-default.css" rel="stylesheet" type="text/css" />
<link href="/theme_assets/css/footer-default.css" rel="stylesheet" type="text/css" />
<link href="/theme_assets/css/color_scheme/red.css" rel="stylesheet" type="text/css" id="color_scheme" />

<!-- Highlighting -->
<link href="https://highlightjs.org/static/demo/styles/github.css" rel="stylesheet" type="text/css" />
<link href="/css/screen.css" rel="stylesheet" type="text/css" />

<!-- Modernizr -->
<script type="text/javascript" src="/theme_assets/plugins/modernizr.min.js"></script>

<!--[if lte IE 8]>
  <script src="/theme_assets/plugins/respond.js"></script>
<![endif]-->

	</head>

	<!--
		Available body classes:
			smoothscroll			= enable chrome browser smooth scroll
			grey 					= grey content background
			boxed 					= boxed style
			pattern1 ... pattern10 	= background pattern

		Background Image - add to body:
			data-background="/theme_assets/images/boxed_background/1.jpg"
	-->
	<body class=" ">

		<div id="wrapper">
			<div id="header">
  <header id="topBar">
    <div class="container">

      

      <!-- Logo -->
      <a class="logo" href="/">
        <img src="/images/akkalogo.png"  alt="" style="padding-top:0px;padding-left: 5px;" />
      </a>

    </div><!-- /.container -->
  </header>
  <div id="topNav">
  <div class="container">
    <!-- Mobile Menu Button -->
    <button class="btn btn-mobile" data-toggle="collapse" data-target=".nav-main-collapse">
      <i class="fa fa-bars"></i>
    </button>

    <!-- Search -->
    <form class="search" method="get" action="/search">
      <input type="text" class="form-control" name="q" value="" placeholder="Search">
      <button class="fa fa-search"></button>
    </form>
    <!-- /Search -->

    <!-- Top Nav -->
    <div class="navbar-collapse nav-main-collapse collapse inline-block">
      <nav class="nav-main">

      

        <!-- pageurl  -->
        <ul id="topMain" class="nav nav-pills nav-main">
          <li class="mega-menu  active">
            <a href="/docs/">DOCUMENTATION<span>&nbsp;</span></a>
          </li>
          <li class="mega-menu">
            <a href="https://github.com/akkadotnet/akka.net/">CODE<span>&nbsp;</span></a>
          </li>
          <li class="mega-menu">
            <a href="https://gitter.im/akkadotnet/akka.net">PROJECT CHAT<span>&nbsp;</span></a>
          </li>
          <li class="mega-menu">
            <a href="https://groups.google.com/forum/#!forum/akkadotnet-user-list">MAILING LIST<span>&nbsp;</span></a>
          </li>
          <li class="mega-menu ">
            <a href="/pages/support">COMMERCIAL SUPPORT<span>&nbsp;</span></a>
          </li>
          <li class="mega-menu ">
            <a href="/docs/Resources">RESOURCES<span>&nbsp;</span></a>
          </li>
        </ul>

      </nav>
    </div>
</div>
</div>
			

			<!-- PAGE TOP -->
			<section class="page-title">
				<div class="container">
					<header>
						<ul class="breadcrumb"><!-- breadcrumb -->
							<li><a href="/">Home</a></li>
							<li><a href="/docs/">Docs</a></li>
							<li class="active">Akka.Cluster.Sharding module<a href="https://github.com/akkadotnet/getakka.net/edit/master/src/docs/clustering/cluster-sharding.md" > (Edit on Github)</a></li>
						</ul><!-- /breadcrumb -->

						<h2><!-- Page Title -->
							<strong>Akka.NET</strong> Docs
						</h2><!-- /Page Title -->

					</header>

				</div>
			</section>
			<!-- /PAGE TOP -->

			<!-- CONTENT -->
			<section>
				<div class="container">

					<div class="row">

						<!-- RIGHT COLUMNS -->
						<div class="col-md-3" id="toc">
						</div>
						<!-- /RIGHT COLUMNS -->

						<!-- LEFT COLUMNS -->
						<div class="col-md-8 docs-content">
							<div id="main_content">

								<div><h1 id="akka-cluster-sharding-module">Akka.Cluster.Sharding module</h1>
<p>Cluster sharding is useful in cases when you want to contact with cluster actors using their logical id&#39;s, but don&#39;t want to care about their physical location inside the cluster or manage their creation. Moreover it&#39;s able to rebalance them, as nodes join/leave the cluster. It&#39;s often used to represent i.e. Aggregate Roots in Domain Driven Design terminology.</p>
<blockquote>
<p>Cluster sharding depends on Akka.Persistence module. In order to use it, you&#39;ll need to specify an event journal accessible by all of the participating nodes.</p>
</blockquote>
<p>Actors managed by cluster sharding are called <strong>entities</strong> and can be automatically distributed across multiple nodes inside the cluster. One entity instance may live only at one node at the time, and can be communicated with via <code>ShardRegion</code> without need to know, what it&#39;s exact node location is.</p>
<p>Example:</p>
<pre><code class="hljs lang-csharp"><span class="hljs-comment">// define envelope used to message routing</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Envelope</span>
{
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">readonly</span> <span class="hljs-keyword">int</span> ShardId;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">readonly</span> <span class="hljs-keyword">int</span> EntityId;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">readonly</span> <span class="hljs-keyword">object</span> Message;

    ...
}

<span class="hljs-comment">// define, how shard id, entity id and message itself should be resolved</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MessageExtractor</span> : <span class="hljs-title">IMessageExtractor</span>
{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">string</span> <span class="hljs-title">EntityId</span>(<span class="hljs-params"><span class="hljs-keyword">object</span> message</span>)
    </span>{
        <span class="hljs-keyword">return</span> (message <span class="hljs-keyword">as</span> Envelope)?.EntityId.ToString();
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">string</span> <span class="hljs-title">ShardId</span>(<span class="hljs-params"><span class="hljs-keyword">object</span> message</span>)
    </span>{
        <span class="hljs-keyword">return</span> (message <span class="hljs-keyword">as</span> Envelope)?.ShardId.ToString();
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">object</span> <span class="hljs-title">EntityMessage</span>(<span class="hljs-params"><span class="hljs-keyword">object</span> message</span>)
    </span>{
        <span class="hljs-keyword">return</span> (message <span class="hljs-keyword">as</span> Envelope)?.Message;
    }
}

<span class="hljs-comment">// register actor type as a sharded entity</span>
<span class="hljs-keyword">var</span> region = ClusterSharding.Get(system).Start(
    typeName: <span class="hljs-string">"my-actor"</span>,
    entityProps: Props.Create&lt;MyActor&gt;(),
    settings: ClusterShardingSettings.Create(system),
    messageExtractor: <span class="hljs-keyword">new</span> MessageExtractor());

<span class="hljs-comment">// send message to entity through shard region</span>
region.Tell(<span class="hljs-keyword">new</span> Envelope(shardId: <span class="hljs-number">1</span>, entityId: <span class="hljs-number">1</span>, message: <span class="hljs-string">"hello"</span>))
</code></pre>
<p>In this example, we first specify way to resolve our messages recipients in context of sharded entities. For this, specialized message type called <code>Envelope</code> and resolution strategy called <code>MessageExtractor</code> have been specified. That part can be customized, and shared among many different shard regions, but it needs to be uniform among all nodes.</p>
<p>Second part of an example is registering custom actor type as sharded entity using <code>ClusterSharding.Start</code> or <code>ClusterSharding.StartAsync</code> methods. Result is the <code>IActorRef</code> to shard region used to communicate between current actor system and target entities. Shard region must be specified once per each type on each node, that is expected to participate in sharding entities of that type.</p>
<p>In case when you want to send message to entities from specific node, but you don&#39;t want that node to participate in sharding itself, you can use <code>ShardRegionProxy</code> for that.</p>
<p>Example:</p>
<pre><code class="hljs lang-csharp"><span class="hljs-keyword">var</span> proxy = ClusterSharding.Get(system).StartProxy(
    typeName: <span class="hljs-string">"my-actor"</span>,
    role: <span class="hljs-keyword">null</span>,
    messageExtractor: <span class="hljs-keyword">new</span> MessageExtractor());
</code></pre>
<h2 id="shards">Shards</h2>
<p>Entities are located and managed automatically. They can also be recreated on the other nodes, as new nodes join the cluster or old ones are leaving it. This process is called rebalancing and for performance reasons it never works on a single entity. Instead all entities are organized and managed in so called shards.</p>
<p>As you may have seen in the examples above shard resolution algorithm is one of the choices you have to make. Good uniform distribution is not an easy task - too small number shards may result in not even distribution of entities across all nodes, while too many of them may increase message routing latency and rebalancing overhead. As a rule of thumb, you may decide to have a number of shards ten times greater than expected maximum number of cluster nodes.</p>
<p>By default rebalancing process always happens from nodes with the highest number of shards, to the ones with the smallest one. This can be configured into by specifying custom implementation of the <code>IShardAllocationStrategy</code> interface in <code>ClusterSharding.Start</code> parameters.</p>
<h2 id="passivation">Passivation</h2>
<p>To reduce memory consumption, you may decide to stop entities after some period of inactivity using <code>Context.SetReceiveTimeout(timeout)</code>. In order to make cluster sharding aware of stopping entities, <strong>DON&#39;T use <code>Context.Stop(Self)</code> on the entities</strong>, as this may result in losing messages. Instead you may send <code>Passivate</code> message message to current entity <code>Context.Parent</code> (which is shard itself in this case). This will trigger shard to stop forwarding messages to target entity, and buffer them instead until it&#39;s terminated. Once that happens, if there are still some messages buffered, entity will be reincarnated and messages flushed to it automatically.</p>
<h2 id="retrieving-sharding-state">Retrieving sharding state</h2>
<p>You can inspect current sharding stats by using following messages:</p>
<ul>
<li>On <code>GetShardRegionState</code> shard region will reply with <code>ShardRegionState</code> containing data about shards living in the current actor system and what entities are alive on each one of them.</li>
<li>On <code>GetClusterShardingStats</code> shard region will reply with <code>ClusterShardingStats</code> having information about shards living in the whole cluster and how many entities alive in each one of them.</li>
</ul>
<h2 id="integrating-cluster-sharding-with-persistent-actors">Integrating cluster sharding with persistent actors</h2>
<p>One of the most common scenarios, where cluster sharding is used, is to combine them with eventsourced persistent actors from <a href="Persistence">Akka.Persistence</a> module. However as the entities are incarnated automatically based on provided props, specifying a dedicated, static unique <code>PersistenceId</code> for each entity may seem troublesome.</p>
<p>This can be resolved by getting information about shard/entity ids directly from actor&#39;s path and constructing unique id from it. For each entity actor path will follow <em>/user/{typeName}/{shardId}/{entityId}</em> pattern, where <em>{typeName}</em> was the parameter provided to <code>ClusterSharding.Start</code> method, while <em>{shardId}</em> and <em>{entityId}</em> where strings returned by message extractor logic. Given these values we can build consistent, unique <code>PersistenceId</code>s on the fly like on the following example:</p>
<pre><code class="hljs lang-csharp"><span class="hljs-keyword">class</span> <span class="hljs-title">Aggregate</span> : <span class="hljs-title">PersistentActor</span>
{
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">string</span> PersistenceId { <span class="hljs-keyword">get</span>; }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Aggregate</span>(<span class="hljs-params"></span>)
    </span>{
        PersistenceId = Context.Parent.Path.Name + <span class="hljs-string">"-"</span> Self.Path.Name;
    }

    ...
}
</code></pre>
</div>

								

						</div>
						<div class="col-md-1">&nbsp;</div>
						<!-- /LEFT COLUMNS -->



					</div>

				</div>
			</section>
			<!-- /CONTENT -->

			<footer id="footer">
  <div class="container">
    <div class="row">
        <!-- col #1 -->
        <div class="spaced dark col-md-3">
            <h4>About <strong>Akka.NET</strong></h4>
            <p class="block">
                Akka.NET is a port of the popular
                <br/> Java/Scala framework <a href="http://akka.io">Akka</a> to .NET.
                <br/>
                <br/> This is a community driven port and
                <br/> is not affiliated with <a href="http://typesafe.com">Typesafe</a> who
                <br/> makes the original Java/Scala version.
                <br/>
            </p>
            <!-- social -->
            <p class="block">
                <a href="mailto:hi@getakka.net">hi@getakka.net</a><br>
                <a href="https://www.facebook.com/akkadotnet" class="social fa fa-facebook"></a>
                <a href="http://stackoverflow.com/questions/tagged/akka.net" class="social fa fa-stack-overflow"></a>
                <a href="https://twitter.com/AkkaDotNET" class="social fa fa-twitter"></a>
            </p><!-- /social -->
        </div>
        <!-- /col #1 -->
        <!-- col #3 -->
        <div class="spaced col-md-6 col-sm-4">
            <h4>Recent <strong>Tweets</strong></h4>
            <ul class="list-unstyled fsize13" id="recent_tweets">
            </ul>
        </div>
        <!-- /col #3 -->
        <div class="spaced col-md-3 col-sm-4">
            <h4>Keep <strong>Updated</strong></h4>
            <h4><small><strong>Subscribe to our Newsletter</strong></small></h4>
            <!-- Begin MailChimp Signup Form -->
<div id="mc_embed_signup">
    <form class="input-group" action="//github.us8.list-manage.com/subscribe/post?u=945d2a2edaa89aaabd396bc45&amp;id=5f9a7a993d" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
        <input type="email" value="" name="EMAIL" class="form-control placeholder required email" id="mce-EMAIL" placeholder="E-mail Address">
        <span class="input-group-btn">
  <button class="btn btn-primary" type="submit" name="subscribe" id="mc-embedded-subscribe">SUBMIT</button>
</span>
        <div id="mce-responses" class="clear">
            <div class="response" id="mce-error-response" style="display:none"></div>
            <div class="response" id="mce-success-response" style="display:none"></div>
        </div>
        <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
        <div style="position: absolute; left: -5000px;">
            <input type="text" name="b_945d2a2edaa89aaabd396bc45_5f9a7a993d" tabindex="-1" value="">
        </div>
        <div class="clear"></div>
    </form>
</div>
<!--End mc_embed_signup-->

        </div>
    </div>
  </div>
  <hr />
  <!-- <div class="copyright">
    <div class="container text-center fsize12"></div>
  </div> -->
</footer>


			<a href="#" id="toTop"></a>

		</div><!-- /#wrapper -->

		<script type="text/javascript" src="/theme_assets/plugins/jquery-2.1.1.min.js"></script>
<script type="text/javascript" src="/theme_assets/plugins/jquery.isotope.js"></script>
<script type="text/javascript" src="/theme_assets/plugins/masonry.js"></script>
<script type="text/javascript" src="/theme_assets/plugins/bootstrap/js/bootstrap.min.js"></script>
<script type="text/javascript" src="/theme_assets/plugins/magnific-popup/jquery.magnific-popup.min.js"></script>
<script type="text/javascript" src="/theme_assets/plugins/owl-carousel/owl.carousel.min.js"></script>
<script type="text/javascript" src="/theme_assets/plugins/knob/js/jquery.knob.js"></script>
<script type="text/javascript" src="/theme_assets/plugins/flexslider/jquery.flexslider-min.js"></script>

<!-- REVOLUTION SLIDER -->
<script type="text/javascript" src="/theme_assets/plugins/revolution-slider/js/jquery.themepunch.plugins.min.js"></script>
<script type="text/javascript" src="/theme_assets/plugins/revolution-slider/js/jquery.themepunch.revolution.min.js"></script>
<script type="text/javascript" src="/theme_assets/js/revolution_slider.js"></script>
<script type="text/javascript" src="/js/jquery-toc.js"></script>
<script type="text/javascript" src="/theme_assets/js/scripts.js"></script>
<script type="text/javascript" src="/js/scripts.js"></script>
		<!-- REACTIVE MANIFESTO BANNER -->
<a href="http://www.reactivemanifesto.org/"> <img style="border: 0; position: fixed; right: 0; top:0; z-index: 9000; max-width: 125px;" src="//d379ifj7s9wntv.cloudfront.net/reactivemanifesto/images/ribbons/we-are-reactive-red-right.png"> </a>

	</body>
</html>
