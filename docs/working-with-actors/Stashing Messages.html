<!DOCTYPE html>
<!--[if IE 8]>			<html class="ie ie8"> <![endif]-->
<!--[if IE 9]>			<html class="ie ie9"> <![endif]-->
<!--[if gt IE 9]><!-->	<html> <!--<![endif]-->
	<head>
		
		<meta charset="utf-8" />
		<title>Stashing Messages | Akka.NET</title>
		
		<meta name="keywords" content="Actor,Finite state machine, concurrency" />
		<meta name="description" content="" />
		<meta name="Author" content="Dorin Grigoras [www.stepofweb.com]" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge" />
		
		<!-- mobile settings -->
		<meta name="viewport" contenht="width=device-width, maximum-scale=1, initial-scale=1, user-scalable=0" />
		
		<!-- Favicon -->
		<link rel="shortcut icon" href="/theme_assets/images/demo/favicon.ico" />
		
		<!-- WEB FONTS -->
		<link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,700,800&amp;subset=latin,latin-ext" rel="stylesheet" type="text/css" />
		
		<!-- CORE CSS -->
		<link href="/theme_assets/plugins/bootstrap/css/bootstrap.min.css" rel="stylesheet" type="text/css" />
		<link href="/theme_assets/css/font-awesome.css" rel="stylesheet" type="text/css" />
		<link href="/theme_assets/css/sky-forms.css" rel="stylesheet" type="text/css" />
		<link href="/theme_assets/css/weather-icons.min.css" rel="stylesheet" type="text/css" />
		<link href="/theme_assets/css/line-icons.css" rel="stylesheet" type="text/css" />
		<link href="/theme_assets/plugins/owl-carousel/owl.pack.css" rel="stylesheet" type="text/css" />
		<link href="/theme_assets/plugins/magnific-popup/magnific-popup.css" rel="stylesheet" type="text/css" />
		<link href="/theme_assets/css/animate.css" rel="stylesheet" type="text/css" />
		<link href="/theme_assets/css/flexslider.css" rel="stylesheet" type="text/css" />
		
		<!-- FAV ICON -->
		<link rel="shortcut icon" href="http://akkadotnet.github.io/favicon.ico?v=2" />
		
		<!-- REVOLUTION SLIDER -->
		<link href="/theme_assets/css/revolution-slider.css" rel="stylesheet" type="text/css" />
		<link href="/theme_assets/css/layerslider.css" rel="stylesheet" type="text/css" />
		
		<!-- BLOG -->
		<link href="/theme_assets/css/layout-blog.css" rel="stylesheet" type="text/css" />
		
		<!-- THEME CSS -->
		<link href="/theme_assets/css/essentials.css" rel="stylesheet" type="text/css" />
		<link href="/theme_assets/css/layout.css" rel="stylesheet" type="text/css" />
		<link href="/theme_assets/css/header-default.css" rel="stylesheet" type="text/css" />
		<link href="/theme_assets/css/footer-default.css" rel="stylesheet" type="text/css" />
		<link href="/theme_assets/css/color_scheme/red.css" rel="stylesheet" type="text/css" id="color_scheme" />
		
		<!-- Highlighting -->
		<link href="https://highlightjs.org/static/styles/github.css" rel="stylesheet" type="text/css" />
		<link href="/css/screen.css" rel="stylesheet" type="text/css" />
		
		<!-- Modernizr -->
		<script type="text/javascript" src="/theme_assets/plugins/modernizr.min.js"></script>
		
		<!-- Live reload -->
		<script src="//localhost:35729/livereload.js"></script>
		
		<!--[if lte IE 8]>
		  <script src="/theme_assets/plugins/respond.js"></script>
		<![endif]-->
	</head>

	<!--
		Available body classes:
			smoothscroll			= enable chrome browser smooth scroll
			grey 					= grey content background
			boxed 					= boxed style
			pattern1 ... pattern10 	= background pattern

		Background Image - add to body:
			data-background="/theme_assets/images/boxed_background/1.jpg"
	-->
	<body class=" smoothscroll">

		<div id="wrapper">
			<div id="header">
			  <header id="topBar">
			    <div class="container">
			
			
			      <!-- Logo -->
			      <a class="logo" href="/">
			        <img src="/images/akkalogo.png"  alt="" style="padding-top:0px;padding-left: 5px;" />
			      </a>
			
			    </div><!-- /.container -->
			  </header>
			  <div id="topNav">
			    <div class="container">
			      <!-- Mobile Menu Button -->
			      <button class="btn btn-mobile" data-toggle="collapse" data-target=".nav-main-collapse">
			        <i class="fa fa-bars"></i>
			      </button>
			  
			      <!-- Search -->
			      <form class="search" method="get" action="/search">
			        <input type="text" class="form-control" name="q" value="" placeholder="Search">
			        <button class="fa fa-search"></button>
			      </form>
			      <!-- /Search -->
			  
			      <!-- Top Nav -->
			      <div class="navbar-collapse nav-main-collapse collapse inline-block">
			        <nav class="nav-main">
			  
			  
			          <!-- pageurl  -->
			          <ul id="topMain" class="nav nav-pills nav-main">
			            <li class="mega-menu ">
			              <a href="/">
			                HOME<span>&nbsp;</span>
			              </a>
			            </li>
			            <li class="mega-menu  active">
			              <a href="/docs/">DOCUMENTATION<span>&nbsp;</span></a>
			            </li>
			            <li class="mega-menu">
			              <a href="https://github.com/akkadotnet/akka.net/">CODE<span>&nbsp;</span></a>
			            </li>
			            <li class="mega-menu">
			              <a href="https://groups.google.com/forum/#!forum/akkadotnet-user-list">MAILING LIST<span>&nbsp;</span></a>
			            </li>
			            <li class="mega-menu ">
			              <a href="/pages/support">COMMERCIAL SUPPORT<span>&nbsp;</span></a>
			            </li>
			            <li class="mega-menu ">
			              <a href="/docs/Resources">RESOURCES<span>&nbsp;</span></a>
			            </li>
			          </ul>
			  
			        </nav>
			      </div>
			  </div></div>			
			<!-- PAGE TOP -->
			<section class="page-title">
				<div class="container">
					<header>
						<ul class="breadcrumb"><!-- breadcrumb -->
							<li><a href="/">Home</a></li>
							<li><a href="/docs/">Docs</a></li>
							<li class="active">Stashing Messages<a href="https://github.com/akkadotnet/getakka.net/edit/master/src/docs/Stashing Messages.md" > (Edit on Github)</a></li>
						</ul><!-- /breadcrumb -->

						<h2><!-- Page Title -->
							<strong>Akka.NET</strong> Docs
						</h2><!-- /Page Title -->

					</header>

				</div>
			</section>
			<!-- /PAGE TOP -->

			<!-- CONTENT -->
			<section>
				<div class="container">

					<div class="row">

						<!-- RIGHT COLUMNS -->
						<div class="col-md-3" id="toc">
						</div>
						<!-- /RIGHT COLUMNS -->

						<!-- LEFT COLUMNS -->
						<div class="col-md-8 docs-content">
							<div id="main_content">

<div><h2 id="stashing-messages">Stashing Messages</h2>
<h3 id="what-is-the-stash-">What is the Stash?</h3>
<p>The Stash is a feature you can enable in your actors so they can temporarily stash away messages they cannot or should not handle at the moment. Another way to see it is that stashing allows you to keep processing messages you can handle while saving for later messages you can&#39;t.</p>
<p>Stashes are handled by Akka.NET out of the actor instance just like the mailbox, so if the actor dies while processing a message, the stash is preserved. This feature is usually used together with <a href="Switchable Behaviors">Become/Unbecome</a>, as they fit together very well, but this is not a requirement.</p>
<h3 id="stash-types">Stash Types</h3>
<p>Akka.NET provides two interfaces for stashing:</p>
<ul>
<li><code>IWithBoundedStash</code> - a stash with limited storage</li>
<li><code>IWithUnboundedStash</code> - a stash with unlimited storage</li>
</ul>
<div class="alert alert-default">
<p><strong>Note:</strong>
As of Akka.NET 1.0, the Bounded Stash is not fully implemented, and it will behave just like an Unbounded Stash.</p>
</div>
<h3 id="using-the-stash">Using the Stash</h3>
<p>In order to add a stash to an actor, implement one of the <a href="#stash-types">stash interfaces</a> in your actor and add the required <code>Stash</code> property:</p>
<pre><code class="hljs lang-cs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MyActor</span> : <span class="hljs-title">ReceiveActor</span>, <span class="hljs-title">IWithUnboundedStash</span>
{
    <span class="hljs-keyword">public</span> IStash Stash { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
}
</code></pre>
<p>Akka.NET recognizes the interface during actor creation and sets the correct stash in the property.</p>
<p>To use the stash, call the methods on the Stash property:</p>
<ul>
<li><code>Stash()</code> - adds the current message to the stash</li>
<li><code>Unstash()</code> - unstashes the oldest message in the stash and prepends to the mailbox</li>
<li><code>UnstashAll()</code> - unstashes all messages from the mail box and prepends in the mailbox (it keeps the messages in the same order as received, unstashing older messages before newer)</li>
</ul>
<p>It is illegal to stash the same message twice. Also, calling any of these methods do not interrupt the current message processing. Usually these methods are called as the last thing you do in your <em>receive logic</em>, so that the next step is usually processing the next message.</p>
<p>The example below shows how to implement an actor with a protocol behavior. The protocol works as follows:</p>
<ol>
<li>The actor starts as <strong>idle</strong> and can receive only <strong>open</strong> messages</li>
<li>If it receives an <strong>open</strong> message, the actor becomes <strong>open</strong></li>
<li>While the actor is <strong>open</strong>:<ul>
<li>it can only receive messages to <strong>write</strong> or <strong>close</strong></li>
<li>any other messages are stashed until the connection is closed</li>
</ul>
</li>
<li>If a <strong>close</strong> message is received, the actor unstashes any other requests received while <strong>open</strong> and becomes <strong>idle</strong></li>
</ol>
<div class="alert alert-default">
<p><strong>Note:</strong> This example requires understanding of <a href="Switchable Behaviors">BecomeStacked/UnbecomeStacked</a>.</p>
</div>
<pre><code class="hljs lang-cs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ActorWithProtocol</span> : <span class="hljs-title">UntypedActor</span>, <span class="hljs-title">IWithUnboundedStash</span>
{
    <span class="hljs-keyword">public</span> IStash Stash { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }

    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnReceive</span><span class="hljs-params">(<span class="hljs-keyword">object</span> message)</span>
    </span>{
        <span class="hljs-comment">// idle</span>
        <span class="hljs-keyword">if</span> (message.Equals(<span class="hljs-string">"open"</span>))
        {
            <span class="hljs-comment">// open</span>
            BecomeStacked(m =&gt;
            {
                <span class="hljs-keyword">if</span> (m.Equals(<span class="hljs-string">"write"</span>))
                {
                    <span class="hljs-comment">// do the writing</span>
                }
                <span class="hljs-function"><span class="hljs-keyword">else</span> <span class="hljs-title">if</span> <span class="hljs-params">(m.Equals(<span class="hljs-string">"close"</span>)</span>)
                </span>{
                    Stash.UnstashAll();
                    UnbecomeStacked();
                }
                <span class="hljs-keyword">else</span>
                {
                    Stash.Stash();
                }
            });
        }
    }
}
</code></pre>
<h4 id="other-use-cases">Other use cases</h4>
<p>While the above example is very simple, one can imagine the stashing concept being applied to many scenarios:</p>
<ul>
<li>An actor that connects to an external server could stash messages while that server is unavailable and unstash them once it comes back online;</li>
<li>An actor could stash query requests while it fetches a dataset to produce responses;</li>
<li>An actor could decide to reduce it&#39;s throughput during peak hours by stashing certain messages and unstashing them at specific intervals to process them in batches instead of real time;</li>
</ul>
<h3 id="advanced">Advanced</h3>
<p>There are some APIs on IStash that are considered <strong>internal</strong> but are exposed publicly for some advanced scenarios. These APIs use <code>Envelope</code> object which hold is the way Akka.NET holds messages internally.</p>
<ul>
<li><p><code>void Prepend(IEnumerable&lt;Envelope&gt; envelopes)</code></p>
<p>Allows you to prepend messages to the stash (<code>Stash</code> method always appends them). This may be used if certain message types should be processed before others during unstash.</p>
</li>
<li><p><code>void UnstashAll(Func&lt;Envelope, bool&gt; predicate)</code></p>
<p>This version of UnstashAll allows you to unstash all messages that match a specific predicate. You may filter messages by sender or content.</p>
<p>Unstash all messages that match a specific predicate.</p>
</li>
<li><p><code>IEnumerable&lt;Envelope&gt; ClearStash()</code></p>
<p>Clears the stash returning all messages that will be discarded.</p>
</li>
</ul>
<div class="alert alert-default">
<p><strong>Note:</strong> The internal API may change without notice, but are part of Akka 1.0.</p>
</div>
</div>

						</div>
						<div class="col-md-1">&nbsp;</div>
						<!-- /LEFT COLUMNS -->



					</div>

				</div>
			</section>
			<!-- /CONTENT -->

			<footer id="footer">
			  <div class="container">
			    <div class="row">
			        <!-- col #1 -->
			        <div class="spaced dark col-md-3">
			            <h4>About <strong>Akka.NET</strong></h4>
			            <p class="block">
			                Akka.NET is a port of the popular
			                <br/> Java/Scala framework <a href="http://akka.io">Akka</a> to .NET.
			                <br/>
			                <br/> This is a community driven port and
			                <br/> is not affiliated with <a href="http://typesafe.com">Typesafe</a> who
			                <br/> makes the original Java/Scala version.
			                <br/>
			            </p>
			            <!-- social -->
			            <p class="block">
			                <a href="mailto:hi@getakka.net">hi@getakka.net</a><br>
			                <a href="https://www.facebook.com/akkadotnet" class="social fa fa-facebook"></a>
			                <a href="http://stackoverflow.com/questions/tagged/akka.net" class="social fa fa-stack-overflow"></a>
			                <a href="https://twitter.com/AkkaDotNET" class="social fa fa-twitter"></a>
			            </p><!-- /social -->
			        </div>
			        <!-- /col #1 -->
			        <!-- col #3 -->
			        <div class="spaced col-md-6 col-sm-4">
			            <h4>Recent <strong>Tweets</strong></h4>
			            <ul class="list-unstyled fsize13" id="recent_tweets">
			            </ul>
			        </div>
			        <!-- /col #3 -->
			        <div class="spaced col-md-3 col-sm-4">
			            <h4>Keep <strong>Updated</strong></h4>
			            <h4><small><strong>Subscribe to our Newsletter</strong></small></h4>
			            <!-- Begin MailChimp Signup Form -->
			            <div id="mc_embed_signup">
			                <form class="input-group" action="//github.us8.list-manage.com/subscribe/post?u=945d2a2edaa89aaabd396bc45&amp;id=5f9a7a993d" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
			                    <input type="email" value="" name="EMAIL" class="form-control placeholder required email" id="mce-EMAIL" placeholder="E-mail Address">
			                    <span class="input-group-btn">
			              <button class="btn btn-primary" type="submit" name="subscribe" id="mc-embedded-subscribe">SUBMIT</button>
			            </span>
			                    <div id="mce-responses" class="clear">
			                        <div class="response" id="mce-error-response" style="display:none"></div>
			                        <div class="response" id="mce-success-response" style="display:none"></div>
			                    </div>
			                    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
			                    <div style="position: absolute; left: -5000px;">
			                        <input type="text" name="b_945d2a2edaa89aaabd396bc45_5f9a7a993d" tabindex="-1" value="">
			                    </div>
			                    <div class="clear"></div>
			                </form>
			            </div>
			            <!--End mc_embed_signup-->
			        </div>
			    </div>
			  </div>
			  <hr />
			  <!-- <div class="copyright">
			    <div class="container text-center fsize12"></div>
			  </div> -->
			</footer>

			<a href="#" id="toTop"></a>

		</div><!-- /#wrapper -->

		<script type="text/javascript" src="/theme_assets/plugins/jquery-2.1.1.min.js"></script>
		<script type="text/javascript" src="/theme_assets/plugins/jquery.isotope.js"></script>
		<script type="text/javascript" src="/theme_assets/plugins/masonry.js"></script>
		<script type="text/javascript" src="/theme_assets/plugins/bootstrap/js/bootstrap.min.js"></script>
		<script type="text/javascript" src="/theme_assets/plugins/magnific-popup/jquery.magnific-popup.min.js"></script>
		<script type="text/javascript" src="/theme_assets/plugins/owl-carousel/owl.carousel.min.js"></script>
		<script type="text/javascript" src="/theme_assets/plugins/knob/js/jquery.knob.js"></script>
		<script type="text/javascript" src="/theme_assets/plugins/flexslider/jquery.flexslider-min.js"></script>
		
		<!-- REVOLUTION SLIDER -->
		<script type="text/javascript" src="/theme_assets/plugins/revolution-slider/js/jquery.themepunch.plugins.min.js"></script>
		<script type="text/javascript" src="/theme_assets/plugins/revolution-slider/js/jquery.themepunch.revolution.min.js"></script>
		<script type="text/javascript" src="/theme_assets/js/revolution_slider.js"></script>
		<script type="text/javascript" src="/js/jquery-toc.js"></script>
		<script type="text/javascript" src="/theme_assets/js/scripts.js"></script>
		<script type="text/javascript" src="/js/scripts.js"></script>		<!-- REACTIVE MANIFESTO BANNER -->
		<a href="http://www.reactivemanifesto.org/"> <img style="border: 0; position: fixed; right: 0; top:0; z-index: 9000; max-width: 125px;" src="//d379ifj7s9wntv.cloudfront.net/reactivemanifesto/images/ribbons/we-are-reactive-red-right.png"> </a>
	</body>
</html>
